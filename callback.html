<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email Verification</title>
    <!-- Load Supabase from CDN with SRI for security -->
    <script src="https://unpkg.com/@supabase/supabase-js@2" integrity="sha384-..." crossorigin="anonymous"></script>
    <!-- Use relative path for config -->
    <script src="js/config.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap");

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 1rem;
        background-color: #181a1b;
        color: #e8e6e3;
        line-height: 1.6;
      }
      .container {
        text-align: center;
        padding: 2.5rem;
        background: #232526;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 100%;
        margin: 1rem;
      }
      .spinner {
        border: 4px solid rgba(74, 144, 226, 0.1);
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border-left-color: #4a90e2;
        animation: spin 1s linear infinite;
        margin: 0 auto 1.5rem;
      }
      .success-icon,
      .error-icon {
        font-size: 48px;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
      }
      .success-icon {
        background-color: #e8f5e9;
        color: #2e7d32;
      }
      .error-icon {
        background-color: #ffebee;
        color: #c62828;
        font-weight: bold;
      }
      h2 {
        color: #e8e6e3;
        margin: 0 0 1rem;
        font-size: 1.5rem;
        font-weight: 600;
      }
      p {
        color: #a8a095;
        margin: 0.5rem 0;
        font-size: 1rem;
      }
      .countdown {
        color: #4a90e2;
        font-weight: 600;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container" id="container">
      <div class="spinner" id="spinner"></div>
      <h2 id="title">Verify your email...</h2>
      <p id="status">Please click the link in your email to continue.</p>
    </div>

    <script>
      // Initialize Supabase with error handling
      if (!window.supabaseConfig) {
        console.error('Configuration not loaded');
        document.getElementById('status').textContent = 'Error: Configuration not loaded. Please try again later.';
        return;
      }
      
      const supabase = createClient(supabaseConfig.url, supabaseConfig.key, {
        auth: {
          autoRefreshToken: true,
          persistSession: true,
          detectSessionInUrl: true,
          flowType: "pkce",
          debug: true,
          storage: window.localStorage,
          storageKey: "sb-auth-token",
        },
      });

      // Make supabase available globally for debugging
      window.supabase = supabase;

      // Handle the email verification
      async function handleEmailVerification() {
        const container = document.getElementById("container");
        const spinner = document.getElementById("spinner");
        const title = document.getElementById("title");
        const status = document.getElementById("status");

        try {
          const hash = window.location.hash;
          console.log("Current hash:", hash);

          if (hash) {
            const hashParams = new URLSearchParams(hash.substring(1));
            const type = hashParams.get("type");
            const accessToken = hashParams.get("access_token");
            const refreshToken = hashParams.get("refresh_token");
            const tokenHash = hashParams.get("token_hash");

            console.log("Hash params:", {
              type,
              accessToken: !!accessToken,
              refreshToken: !!refreshToken,
              tokenHash: !!tokenHash,
            });

            // Handle different types of email verification
            if (type === "signup") {
              let authResult;

              if (tokenHash) {
                // Use verifyOtp for token_hash method
                authResult = await supabase.auth.verifyOtp({
                  token_hash: tokenHash,
                  type: "signup",
                });
              } else if (accessToken && refreshToken) {
                // Use setSession for access_token method
                authResult = await supabase.auth.setSession({
                  access_token: accessToken,
                  refresh_token: refreshToken,
                });
              } else {
                throw new Error("Invalid verification tokens");
              }

              if (authResult.error) throw authResult.error;

              // Show success message
              spinner.style.display = "none";
              container.innerHTML = `
                            <div class="success-icon">✓</div>
                            <h2>Email Verified Successfully!</h2>
                            <p>Your email has been verified. You'll be redirected to your dashboard in <span class="countdown" id="countdown">3</span> seconds.</p>
                        `;

              // Countdown and redirect
              let countdown = 3;
              const countdownElement = document.getElementById("countdown");
              const countdownInterval = setInterval(() => {
                countdown--;
                if (countdownElement) {
                  countdownElement.textContent = countdown;
                }

                if (countdown <= 0) {
                  clearInterval(countdownInterval);
                  // Clear the hash and redirect
                  window.history.replaceState(
                    {},
                    document.title,
                    window.location.pathname
                  );
                  window.location.href = "reminders.html";
                }
              }, 1000);

              return;
            }

            // Handle other types like email_change if needed
            if (type === "email_change" && tokenHash) {
              const { data, error } = await supabase.auth.verifyOtp({
                token_hash: tokenHash,
                type: "email_change",
              });

              if (error) throw error;

              spinner.style.display = "none";
              container.innerHTML = `
                            <div class="success-icon">✓</div>
                            <h2>Email Updated Successfully!</h2>
                            <p>Your email has been updated. You'll be redirected to your dashboard in <span class="countdown" id="countdown">3</span> seconds.</p>
                        `;

              setTimeout(() => {
                window.location.href = "reminders.html";
              }, 3000);

              return;
            }
          }

          // If we get here, check if there's already a session
          const {
            data: { session },
            error,
          } = await supabase.auth.getSession();

          if (session) {
            // User is already authenticated, redirect
            status.textContent = "Already authenticated. Redirecting...";
            setTimeout(() => {
              window.location.href = "reminders.html";
            }, 1000);
            return;
          }

          // No valid session or tokens, redirect to login
          throw new Error("No valid authentication tokens found");
        } catch (error) {
          console.error("Email verification error:", error);

          spinner.style.display = "none";
          container.innerHTML = `
                    <div class="error-icon">!</div>
                    <h2>Verification Error</h2>
                    <p>${
                      error.message ||
                      "There was an issue verifying your email. Please try again."
                    }</p>
                    <p>You'll be redirected to the login page in <span class="countdown" id="error-countdown">5</span> seconds.</p>
                `;

          // Error countdown and redirect
          let countdown = 5;
          const countdownElement = document.getElementById("error-countdown");
          const countdownInterval = setInterval(() => {
            countdown--;
            if (countdownElement) {
              countdownElement.textContent = countdown;
            }

            if (countdown <= 0) {
              clearInterval(countdownInterval);
              window.location.href = "index.html";
            }
          }, 1000);
        }
      }

      // Start the verification process when the page loads
      document.addEventListener("DOMContentLoaded", handleEmailVerification);
    </script>
  </body>
</html>
